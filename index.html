<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toronto Kids Events - Weekly Listings</title>
    <!-- Version 2.23 - Performance: Eliminated all render-blocking resources -->

    <!-- Metadata no longer needed - meta tags are now static for SEO/GA consistency -->

    <!-- Force browser to reload updated JavaScript - no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta id="meta-description" name="description" content="Find free kids events in Toronto. Discover recurring community programs, Indigenous activities, nature workshops, library storytimes, museum free days, Parks & Rec drop-ins, and grassroots family events. Updated daily.">

    <meta name="keywords" content="Toronto kids events, Toronto children activities, free kids events Toronto, Toronto family events, kids activities Toronto today, Toronto community events, Indigenous kids programs Toronto, nature workshops Toronto kids, Toronto library events children, museum free days Toronto, Parks and Recreation Toronto kids, EarlyON Toronto, grassroots kids events, holistic parenting Toronto, Toronto outdoor kids activities, free family activities Toronto, kids events near me Toronto, things to do with kids Toronto, Toronto toddler activities, Toronto baby programs, Toronto teen events">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Toronto Kids Events - Weekly Listings">
    <meta property="og:description" content="Find free kids events in Toronto. Recurring community programs, library storytimes, Parks & Rec drop-ins & more. Updated daily.">
    <meta property="og:url" content="https://joshuaopolko.com/kidsevents/">
    <meta property="og:image" content="https://joshuaopolko.com/kidsevents/kids-twitter.jpg?v=1761934337">
    <meta property="og:image:secure_url" content="https://joshuaopolko.com/kidsevents/kids-twitter.jpg?v=1761934337">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/jpeg">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@joshuaopolko">
    <meta name="twitter:url" content="https://joshuaopolko.com/kidsevents/">
    <meta name="twitter:title" content="Toronto Kids Events - Weekly Listings">
    <meta name="twitter:description" content="Find free kids events in Toronto. Recurring community programs, library events & more. Updated daily.">
    <meta name="twitter:image" content="https://joshuaopolko.com/kidsevents/kids-twitter.jpg?v=1761934337">
    <meta name="twitter:image:alt" content="Toronto Kids Events">

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.googletagmanager.com">

    <!-- Async font loading to eliminate render-blocking -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet"></noscript>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1GZN9MX2P4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1GZN9MX2P4');
    </script>
    <!-- End Google Analytics -->

    <style>
        /* Inline SVG icons to replace Font Awesome */
        .icon { display: inline-block; width: 1em; height: 1em; vertical-align: -0.125em; }
        .icon svg { width: 100%; height: 100%; fill: currentColor; }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 25%, #BAE6FD 50%, #7DD3FC 75%, #F0F9FF 100%);
            background-size: 400% 400%;
            background-attachment: fixed;
            animation: gradientShift 20s ease infinite;
            color: #1E293B;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 50% 25%; }
            50% { background-position: 100% 50%; }
            75% { background-position: 50% 75%; }
            100% { background-position: 0% 50%; }
        }

        /* Performance optimization for animations */
        .card, .event {
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card:hover, .event:hover { will-change: auto; }

        /* Optimize background gradient rendering */
        body {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeIn 1s ease;
        }

        .time {
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 10px;
        }

        .date {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 1.5rem;
            opacity: 0.85;
        }

        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.15);
            border-radius: 24px;
            padding: 24px;
            transition: all 0.3s ease;
            animation: slideUp 0.6s ease;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.12);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: #D81B60;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px rgba(216, 27, 96, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .age-filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .age-filter-btn {
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid #E0E7FF;
            background: white;
            color: #4F46E5;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: none;
            letter-spacing: 0.3px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.08);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .age-filter-btn:hover {
            background: #EEF2FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
            border-color: #C7D2FE;
        }

        .age-filter-btn:active {
            transform: translateY(0);
        }

        .age-filter-btn.active {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            color: white;
            border-color: #8B5CF6;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        /* Age filter select styling */
        #age-filter-select {
            transition: all 0.2s ease;
        }

        #age-filter-select:hover {
            border-color: #C7D2FE;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        #age-filter-select:focus {
            outline: none;
            border-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .age-filter-btn {
                padding: 14px 20px;
                font-size: 0.95rem;
                min-height: 48px;
                border-radius: 12px;
                flex: 1 1 auto;
                min-width: 140px;
                max-width: 180px;
            }

            #age-filter-select {
                font-size: 0.9rem;
                padding: 12px 14px;
                padding-right: 36px;
                min-height: 48px;
            }

            .container {
                padding: 20px 16px;
            }

            .card {
                padding: 20px;
                border-radius: 20px;
            }
        }

        .big-stat {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Grid sizes */
        .span-4 { grid-column: span 4; }
        .span-3 { grid-column: span 3; }
        .span-6 { grid-column: span 6; }
        .span-8 { grid-column: span 8; }
        .span-12 { grid-column: span 12; }

        /* Events */
        .events-grid {
            display: grid;
            gap: 15px;
        }

        .event {
            border-radius: 20px;
            padding: 20px;
            border: 4px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            display: block;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Fun rotating background colors for each event */
        .event:nth-child(6n+1) {
            background: linear-gradient(135deg, #FFD93D 0%, #FFF4A3 100%);
        }
        .event:nth-child(6n+2) {
            background: linear-gradient(135deg, #FF6B9D 0%, #FFB3D9 100%);
        }
        .event:nth-child(6n+3) {
            background: linear-gradient(135deg, #E6B3FF 0%, #F5D9FF 100%);
        }
        .event:nth-child(6n+4) {
            background: linear-gradient(135deg, #A0E7E0 0%, #C7F5E5 100%);
        }
        .event:nth-child(6n+5) {
            background: linear-gradient(135deg, #C5F0E8 0%, #E3FCF4 100%);
        }
        .event:nth-child(6n+6) {
            background: linear-gradient(135deg, #FFD1A3 0%, #FFE8C2 100%);
        }

        .event-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .event.temporal {
            border: 5px solid #E6B3FF;
            box-shadow: 0 8px 30px rgba(199, 75, 237, 0.4);
        }

        .event.happening-now {
            background: linear-gradient(135deg, #FFD93D 0%, #FFF4A3 100%) !important;
            border: 5px solid #FFB3D9;
            box-shadow: 0 10px 35px rgba(255, 107, 157, 0.5);
        }

        .happening-now-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #FFE99D 0%, #FFD1A3 100%);
            color: #000;
            padding: 5px 14px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 800;
            margin-left: 10px;
            box-shadow: 0 3px 12px rgba(255, 217, 61, 0.5);
        }

        .event:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
            border-color: white;
        }

        .event-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #E6B3FF 0%, #FFB3D9 100%);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 800;
            margin-left: 10px;
            box-shadow: 0 3px 12px rgba(199, 75, 237, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-main {
            min-width: 0;
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: 900;
            margin-bottom: 12px;
            color: #000;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.9), 0 0 8px rgba(255, 255, 255, 0.8);
        }

        .event-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            flex-wrap: wrap;
            align-items: center;
            color: #000;
            font-weight: 600;
        }

        .event-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .event-organizer {
            font-size: 0.85rem;
            color: #000;
            opacity: 0.8;
            margin-top: 8px;
            font-weight: 600;
        }

        .event-actions {
            display: flex;
            gap: 8px;
            flex-direction: column;
        }

        .event-btn {
            background: #8B9DC3;
            border: 3px solid white;
            color: white;
            padding: 12px 20px;
            border-radius: 18px;
            font-size: 0.9rem;
            font-weight: 800;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 5px 20px rgba(45, 53, 97, 0.4);
        }

        .event-btn:hover {
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 8px 30px rgba(45, 53, 97, 0.6);
            background: #FFB3D9;
        }

        .event-btn i {
            font-size: 1rem;
        }

        .event-btn.secondary {
            background: white;
            color: #000;
            border: 3px solid #8B9DC3;
            box-shadow: 0 4px 15px rgba(45, 53, 97, 0.3);
            font-weight: 800;
        }

        .event-btn.secondary:hover {
            background: #A0E7E0;
            color: white;
            border-color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(78, 205, 196, 0.5);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .event-description {
            background: rgba(255, 255, 255, 0.8);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            line-height: 1.7;
            color: #000;
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.9);
        }

        .event-extra-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .info-tag {
            background: rgba(255, 255, 255, 0.7);
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid white;
            color: #000;
            font-weight: 700;
        }

        .info-tag .icon {
            color: #D81B60;
        }

        /* Neighborhoods */
        .neighborhood-list {
            display: grid;
            gap: 12px;
        }

        .neighborhood-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .neighborhood-name {
            font-weight: 600;
        }

        .neighborhood-stat {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Weather-like widget */
        .weather-widget {
            text-align: center;
        }

        .weather-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .weather-temp {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #000;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 115, 85, 0.1);
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Quick links */
        .quick-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .quick-link {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .quick-link:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @media (max-width: 1024px) {
            .span-4, .span-3, .span-6, .span-8 {
                grid-column: span 6;
            }
        }

        @media (max-width: 768px) {
            .span-4, .span-3, .span-6, .span-8, .span-12 {
                grid-column: span 12;
            }

            .time {
                font-size: 2.5rem;
            }

            .big-stat {
                font-size: 2rem;
            }

            .dashboard {
                gap: 15px;
            }

            .event {
                padding: 15px;
            }

            .event-header {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .event-title {
                font-size: 1rem;
            }

            .event-meta {
                gap: 10px;
                font-size: 0.8rem;
            }

            .event-meta span {
                white-space: normal;
            }

            .event-actions {
                flex-direction: row;
                gap: 6px;
                flex-wrap: wrap;
            }

            .event-btn {
                padding: 8px 14px;
                font-size: 0.8rem;
                flex: 1 1 auto;
                min-width: 80px;
            }

            .event-badge, .happening-now-badge {
                font-size: 0.65rem;
                padding: 2px 8px;
                margin-left: 5px;
            }

            .event-organizer {
                font-size: 0.75rem;
            }

            .event-description {
                padding: 12px;
                font-size: 0.85rem;
            }

            .event-extra-info {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .info-tag {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .event-quick-actions {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            h1 {
                font-size: 2.8rem !important;
                font-weight: 950 !important;
                letter-spacing: -1px !important;
            }

            #week-range {
                font-size: 1rem !important;
            }
        }

        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-header {
            height: 60px;
            width: 70%;
            margin: 20px auto;
        }

        .skeleton-card {
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            background: white;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 15px;
        }

        .skeleton-text {
            height: 16px;
            width: 100%;
            margin-bottom: 10px;
        }

        .skeleton-text.short {
            width: 40%;
        }

        #loading-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>

    <!-- Metadata loaded for potential future use; meta tags kept static for GA consistency -->

    <!-- PWA Manifest -->
    <link rel="manifest" href="/kidsevents/manifest.json">

    <!-- Apple iOS specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kids Events">
    <link rel="apple-touch-icon" href="/kidsevents/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/kidsevents/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/kidsevents/icons/icon-192x192.png">

    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#4CAF50">
</head>
<body>
    <div id="loading" style="min-height: 100vh; background: linear-gradient(135deg, #A4B3F5 0%, #B497D6 100%);">
        <div id="loading-container">
            <div class="skeleton skeleton-header"></div>
            <div class="skeleton-card">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
            </div>
        </div>
    </div>

    <div class="container" id="content" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1 style="font-size: 4rem; font-weight: 900; margin-bottom: 20px; letter-spacing: -2px;"><a href="https://joshuaopolko.com/kidsevents/" style="color: #4F46E5; text-decoration: none; filter: drop-shadow(2px 4px 8px rgba(79, 70, 229, 0.2));">Toronto Kids Events</a></h1>
            <div id="week-range" style="font-size: 1.3rem; color: #6366F1; text-shadow: 0 2px 4px rgba(99, 102, 241, 0.15); font-weight: 600; margin-bottom: 15px; letter-spacing: 0.5px;">Loading...</div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Events -->
            <div class="card span-12">
                <!-- Search and Filters Row -->
                <div style="margin-bottom: 20px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                    <!-- Search Bar (Left) -->
                    <div style="position: relative; flex: 1; min-width: 340px; max-width: 650px;">
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Loading events..."
                            disabled
                            style="width: 100%; padding: 12px 44px 12px 44px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 0.95rem; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.04); background: #F9FAFB;"
                            onfocus="this.style.borderColor='#6366F1'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.15)'; this.style.background='white'"
                            onblur="this.style.borderColor='#E5E7EB'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)'"
                        />
                        <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #9CA3AF; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <button
                            id="clear-search-btn"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #9CA3AF; cursor: pointer; padding: 4px; display: none; transition: color 0.2s ease;"
                            onmouseover="this.style.color='#EF4444'"
                            onmouseout="this.style.color='#9CA3AF'"
                        >
                            <svg style="width: 18px; height: 18px;" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Age Filter Dropdown (Right) -->
                    <div style="display: flex; gap: 8px; align-items: center; justify-content: flex-end;">
                        <select id="age-filter-select" style="padding: 12px 16px; border-radius: 12px; border: 2px solid #E0E7FF; background: white; color: #4F46E5; font-size: 0.95rem; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.08); appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%234F46E5%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px;">
                            <option value="all">All Ages</option>
                            <option value="Babies (0-2)">üë∂ Babies (0-2)</option>
                            <option value="Toddlers (3-5)">üßí Toddlers (3-5)</option>
                            <option value="Kids (6-12)">üëß Kids (6-12)</option>
                        </select>
                        <button class="age-filter-btn" id="near-me-btn" style="background: linear-gradient(135deg, #06B6D4 0%, #0891B2 100%); color: white; border-color: #0891B2; white-space: nowrap;">üìç Near Me</button>
                    </div>
                </div>
                <div class="events-grid" id="today-events">
                    <div style="opacity: 0.5;">Loading events...</div>
                </div>
                <div id="show-more-container" style="text-align: center; margin-top: 30px; display: none;">
                    <button id="show-more-btn" onclick="showMoreEvents()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(99, 102, 241, 0.2)'" style="background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); color: white; border: none; padding: 16px 48px; border-radius: 12px; font-size: 1.05rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2); transition: all 0.3s ease; min-height: 52px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
                        Load Next 20
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); margin-top: 80px; padding: 30px 20px; border-top: 4px solid rgba(255, 107, 157, 0.3); box-shadow: 0 -8px 25px rgba(0, 0, 0, 0.1);">
        <div class="container" style="max-width: 1400px; margin: 0 auto;">
            <div style="text-align: center; display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; align-items: center;">
                <a href="#" class="footer-link" onclick="event.preventDefault(); showAboutModal(); return false;" style="color: #000; font-weight: 700; text-decoration: none; transition: color 0.2s;">About</a>
                <a href="#" class="footer-link" onclick="event.preventDefault(); showSourcesModal(); return false;" style="color: #000; font-weight: 700; text-decoration: none; transition: color 0.2s;">Data Sources</a>
                <a href="#" class="footer-link" onclick="event.preventDefault(); showContactModal(); return false;" style="color: #000; font-weight: 700; text-decoration: none; transition: color 0.2s;">Contact</a>
                <a href="https://joshuaopolko.com/hometurf" target="_blank" rel="noopener noreferrer" class="footer-link" style="color: #000; font-weight: 700; text-decoration: none; transition: color 0.2s;">HomeTurf</a>
            </div>
        </div>
    </footer>

    <!-- Load events from JSON (deferred to prevent render-blocking) -->
    <script defer src="load_events.js?v=2.15"></script>

    <script>
        // Version check - force cache clear if seeing old distances
        console.log('üéØ Toronto Kids Events v2.16 - Compact dropdown age filter - ' + new Date().toISOString());

        // Global variables (accessed directly on window object by load_events.js)
        var events = [];
        var userLocation = null;
        var currentEvents = []; // Store currently displayed events
        var allFilteredEvents = []; // Store all filtered events for pagination
        var displayedCount = 20; // Number of events currently displayed
        var searchQuery = ''; // Track current search query

        // Icon helper - inline SVG icons (replaces Font Awesome)
        const icons = {
            'map-marker-alt': '<svg viewBox="0 0 384 512"><path d="M172.268 501.67C26.97 291.031 0 269.413 0 192 0 85.961 85.961 0 192 0s192 85.961 192 192c0 77.413-26.97 99.031-172.268 309.67-9.535 13.774-29.93 13.773-39.464 0zM192 272c44.183 0 80-35.817 80-80s-35.817-80-80-80-80 35.817-80 80 35.817 80 80 80z"/></svg>',
            'location-arrow': '<svg viewBox="0 0 512 512"><path d="M444.52 3.52L28.74 195.42c-47.97 22.39-31.98 92.75 19.19 92.75h175.91v175.91c0 51.17 70.36 67.17 92.75 19.19l191.9-415.78c15.99-38.39-25.59-79.97-63.97-63.97z"/></svg>',
            'phone': '<svg viewBox="0 0 512 512"><path d="M493.4 24.6l-104-24c-11.3-2.6-22.9 3.3-27.5 13.9l-48 112c-4.2 9.8-1.4 21.3 6.9 28l60.6 49.6c-36 76.7-98.9 140.5-177.2 177.2l-49.6-60.6c-6.8-8.3-18.2-11.1-28-6.9l-112 48C3.9 366.5-2 378.1.6 389.4l24 104C27.1 504.2 36.7 512 48 512c256.1 0 464-207.5 464-464 0-11.2-7.7-20.9-18.6-23.4z"/></svg>',
            'directions': '<svg viewBox="0 0 512 512"><path d="M502.61 233.32L278.68 9.39c-12.52-12.52-32.83-12.52-45.36 0L9.39 233.32c-12.52 12.53-12.52 32.83 0 45.36l223.93 223.93c12.52 12.53 32.83 12.53 45.36 0l223.93-223.93c12.52-12.53 12.52-32.83 0-45.36zm-100.98 12.56l-84.21 77.73c-5.12 4.73-13.43 1.1-13.43-5.88V264h-96v64c0 4.42-3.58 8-8 8h-32c-4.42 0-8-3.58-8-8v-80c0-17.67 14.33-32 32-32h112v-53.73c0-6.97 8.3-10.61 13.43-5.88l84.21 77.73c3.43 3.17 3.43 8.59 0 11.76z"/></svg>',
            'calendar-plus': '<svg viewBox="0 0 448 512"><path d="M436 160H12c-6.6 0-12-5.4-12-12v-36c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48v36c0 6.6-5.4 12-12 12zM12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm316 140c0-6.6-5.4-12-12-12h-60v-60c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v60h-60c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h60v60c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-60h60c6.6 0 12-5.4 12-12v-40z"/></svg>',
            'sms': '<svg viewBox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32zm96 240h-64v64c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-64h-64c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16h64v-64c0-8.8 7.2-16 16-16h32c8.8 0 16 7.2 16 16v64h64c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16z"/></svg>',
            'cloud-sun': '<svg viewBox="0 0 640 512"><path d="M575.2 325.7c.2-1.9.8-3.7.8-5.6 0-35.3-28.7-64-64-64-12.6 0-24.2 3.8-34.1 10-17.6-38.8-56.5-66-101.9-66-61.8 0-112 50.1-112 112 0 3 .7 5.8.9 8.7-49.6 3.7-88.9 44.7-88.9 95.3 0 52.9 43.1 96 96 96h272c52.9 0 96-43.1 96-96 0-41.8-26.9-77.4-64.8-90.4zM144.4 240.1C163.3 138.1 251.3 64 352 64c68.5 0 128.9 35.6 163.3 89.5 6.4-1 12.9-1.5 19.6-1.5 70.7 0 128 57.3 128 128 0 13.3-2.2 26.1-6.1 38.2 49.6-7.7 86.1-51.7 86.1-104.2 0-70.7-57.3-128-128-128-32.9 0-62.8 12.5-85.5 32.9C494.2 63.9 427.9 32 352 32 232.3 32 136.4 125.2 144.4 240.1zM103.4 401.2c-10.3 0-19.9-4.4-26.6-12.2-6.7-7.8-9.4-18.2-7.6-28.5 2.9-16.4-11.4-30.1-27.7-26.6C15.1 340.4-1 361.6.2 387c1.2 25.4 21.9 46 47.2 47.1 25.3 1.1 46.8-18.8 47.9-44 1.1-25.2-18.7-46.7-43.8-47.9 1.2 25.4 21.9 46 47.2 47.1 2.5.1 5 .2 7.5.2h215.8c15.5 0 28-12.5 28-28s-12.5-28-28-28h-216c-1.1 0-2.1 0-3.2.1-17.8 1.1-32.8-12.9-32.8-30.6 0-16.5 13.1-30 29.5-30.7 17.8-1.1 33.4 12.5 34.5 30.3.5 8.7 7.7 15.7 16.5 15.7h177.2c15.5 0 28-12.5 28-28s-12.5-28-28-28h-94.1c1.7-10.3 2.6-20.9 2.6-31.6 0-88.4-71.6-160-160-160S32 111.6 32 200c0 10.7.9 21.3 2.6 31.6h68.8z"/></svg>',
            'star': '<svg viewBox="0 0 576 512"><path d="M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z"/></svg>',
            'info-circle': '<svg viewBox="0 0 512 512"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/></svg>',
            'book': '<svg viewBox="0 0 448 512"><path d="M448 360V24c0-13.3-10.7-24-24-24H96C43 0 0 43 0 96v320c0 53 43 96 96 96h328c13.3 0 24-10.7 24-24v-16c0-7.5-3.5-14.3-8.9-18.7-4.2-15.4-4.2-59.3 0-74.7 5.4-4.3 8.9-11.1 8.9-18.6zM128 134c0-3.3 2.7-6 6-6h212c3.3 0 6 2.7 6 6v20c0 3.3-2.7 6-6 6H134c-3.3 0-6-2.7-6-6v-20zm0 64c0-3.3 2.7-6 6-6h212c3.3 0 6 2.7 6 6v20c0 3.3-2.7 6-6 6H134c-3.3 0-6-2.7-6-6v-20zm253.4 250H96c-17.7 0-32-14.3-32-32 0-17.6 14.4-32 32-32h285.4c-1.9 17.1-1.9 46.9 0 64z"/></svg>',
            'landmark': '<svg viewBox="0 0 512 512"><path d="M501.62 92.11L267.24 2.04a31.958 31.958 0 0 0-22.47 0L10.38 92.11A16.001 16.001 0 0 0 0 107.09V144c0 8.84 7.16 16 16 16h480c8.84 0 16-7.16 16-16v-36.91c0-6.67-4.14-12.64-10.38-14.98zM64 192v160H48c-8.84 0-16 7.16-16 16v48h448v-48c0-8.84-7.16-16-16-16h-16V192h-64v160h-96V192h-64v160h-96V192H64zm432 256H16c-8.84 0-16 7.16-16 16v32c0 8.84 7.16 16 16 16h480c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16z"/></svg>',
            'ticket-alt': '<svg viewBox="0 0 576 512"><path d="M128 160h320v192H128V160zm400 96c0 26.51 21.49 48 48 48v96c0 26.51-21.49 48-48 48H48c-26.51 0-48-21.49-48-48v-96c26.51 0 48-21.49 48-48s-21.49-48-48-48v-96c0-26.51 21.49-48 48-48h480c26.51 0 48 21.49 48 48v96c-26.51 0-48 21.49-48 48zm-48-104c0-13.255-10.745-24-24-24H120c-13.255 0-24 10.745-24 24v208c0 13.255 10.745 24 24 24h336c13.255 0 24-10.745 24-24V152z"/></svg>',
            'calendar-alt': '<svg viewBox="0 0 448 512"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>',
            'leaf': '<svg viewBox="0 0 576 512"><path d="M546.2 9.7c-5.6-12.5-21.6-13-28.3-1.2C486.9 62.4 431.4 96 368 96h-80C182 96 96 182 96 288c0 7 .8 13.7 1.5 20.5C161.3 262.8 253.4 224 384 224c8.8 0 16 7.2 16 16s-7.2 16-16 16C132.6 256 26 410.1 2.4 468c-6.6 16.3 1.2 34.9 17.5 41.6 16.4 6.8 35-1.1 41.8-17.3 1.5-3.6 20.9-47.9 71.9-90.6 32.4 43.9 94 85.8 174.9 77.2C465.5 467.5 576 326.7 576 154.3c0-50.2-10.8-102.2-29.8-144.6z"/></svg>',
            'external-link-alt': '<svg viewBox="0 0 512 512"><path d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"/></svg>',
            'user-circle': '<svg viewBox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg>',
            'users': '<svg viewBox="0 0 640 512"><path d="M96 224c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm448 0c35.3 0 64-28.7 64-64s-28.7-64-64-64-64 28.7-64 64 28.7 64 64 64zm32 32h-64c-17.6 0-33.5 7.1-45.1 18.6 40.3 22.1 68.9 62 75.1 109.4h66c17.7 0 32-14.3 32-32v-32c0-35.3-28.7-64-64-64zm-256 0c61.9 0 112-50.1 112-112S381.9 32 320 32 208 82.1 208 144s50.1 112 112 112zm76.8 32h-8.3c-20.8 10-43.9 16-68.5 16s-47.6-6-68.5-16h-8.3C179.6 288 128 339.6 128 403.2V432c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48v-28.8c0-63.6-51.6-115.2-115.2-115.2zm-223.7-13.4C161.5 263.1 145.6 256 128 256H64c-35.3 0-64 28.7-64 64v32c0 17.7 14.3 32 32 32h65.9c6.3-47.4 34.9-87.3 75.2-109.4z"/></svg>',
            'home': '<svg viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"/></svg>',
            'sun': '<svg viewBox="0 0 512 512"><path d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6 0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c13-6.5 13-24.7.2-31.1zm-155.9 106c-49.9 49.9-131.1 49.9-181 0-49.9-49.9-49.9-131.1 0-181 49.9-49.9 131.1-49.9 181 0 49.9 49.9 49.9 131.1 0 181z"/></svg>',
            'location-dot': '<svg viewBox="0 0 384 512"><path d="M215.7 499.2C267 435 384 279.4 384 192 384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2 12.3 15.3 35.1 15.3 47.4 0zM192 256c-35.3 0-64-28.7-64-64s28.7-64 64-64 64 28.7 64 64-28.7 64-64 64z"/></svg>',
            'copy': '<svg viewBox="0 0 448 512"><path d="M320 448v40c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V120c0-13.255 10.745-24 24-24h72v296c0 30.879 25.121 56 56 56h168zm0-344V0H152c-13.255 0-24 10.745-24 24v368c0 13.255 10.745 24 24 24h272c13.255 0 24-10.745 24-24V128H344c-13.2 0-24-10.8-24-24zm120.971-31.029L375.029 7.029A24 24 0 0 0 358.059 0H352v96h96v-6.059a24 24 0 0 0-7.029-16.97z"/></svg>',
            'check': '<svg viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg>',
            'clock': '<svg viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>'
        };

        function icon(name) {
            return `<span class="icon">${icons[name] || ''}</span>`;
        }

        // Copy event details to clipboard
        function copyEvent(eventId) {
            console.log('üîµ copyEvent called with ID:', eventId);
            console.log('üîµ currentEvents exists:', !!currentEvents);
            console.log('üîµ currentEvents length:', currentEvents ? currentEvents.length : 0);

            const event = currentEvents.find(e => e.id === eventId);
            if (!event) {
                console.error('‚ùå Event not found with ID:', eventId);
                alert('Could not find event. Please try again.');
                return;
            }

            console.log('‚úÖ Found event:', event.title);

            const eventDate = new Date(event.date + 'T' + event.start_time);
            const dateStr = eventDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const startTime = formatTime12Hour(event.start_time);
            const endTime = event.end_time ? formatTime12Hour(event.end_time) : '';
            const timeStr = endTime ? `${startTime} - ${endTime}` : startTime;

            let text = `üìÖ ${event.title}\n\n`;
            text += `üóìÔ∏è ${dateStr}\n`;
            text += `üïê ${timeStr}\n`;
            text += `üìç ${event.venue.name || event.venue.neighborhood}\n`;
            if (event.venue.address) {
                text += `   ${event.venue.address}\n`;
            }
            text += `${event.icon} ${event.category}\n`;
            if (event.age_groups && event.age_groups.length) {
                text += `üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${event.age_groups.join(', ')}\n`;
            }
            if (event.indoor_outdoor) {
                text += `${event.indoor_outdoor === 'Outdoor' ? '‚òÄÔ∏è' : 'üè†'} ${event.indoor_outdoor}\n`;
            }
            if (event.organized_by) {
                text += `üè¢ ${event.organized_by}\n`;
            }
            if (event.description && event.description.trim() !== event.title.trim()) {
                text += `\n${event.description}\n`;
            }
            if (event.website) {
                let websiteUrl = event.website;
                if (!websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                    websiteUrl = 'https://' + websiteUrl;
                }
                text += `\nüîó ${websiteUrl}`;
            }

            text += `\n\n‚ú® Found on Toronto Kids Events\nhttps://joshuaopolko.com/kidsevents/`;

            console.log('üìã Full text to copy (length=' + text.length + '):');
            console.log(text);

            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                console.log('‚úÖ Copy to clipboard successful!');
                // Visual feedback
                const btn = document.querySelector(`[data-event-id="${eventId}"] .copy-btn`);
                console.log('üîò Button found:', !!btn);
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = `${icon('check')} Copied!`;
                    btn.style.background = 'linear-gradient(135deg, #7FD4AA 0%, #5FC48D 100%)';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = 'linear-gradient(135deg, #A0E7E0 0%, #88CFC0 100%)';
                    }, 2000);
                }
            }).catch(err => {
                console.error('‚ùå Copy failed:', err);
                alert('Could not copy to clipboard: ' + err.message);
            });
        }

        // Convert 24-hour time to 12-hour AM/PM format
        function formatTime12Hour(time24) {
            if (!time24) return '';

            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hours12 = hours % 12 || 12;

            return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // Update date range header to show total events in coming week
        function updateDateRangeHeader(events) {
            const dateRangeEl = document.getElementById('week-range');
            if (!dateRangeEl) return;

            // Only update if not searching
            if (searchQuery && searchQuery.trim() !== '') {
                return; // Let search results message stay
            }

            // Calculate events in the coming week (next 7 days)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            const todayStr = today.toISOString().split('T')[0];
            const nextWeekStr = nextWeek.toISOString().split('T')[0];

            // Count events in currentEvents (which is already filtered to next 7 days)
            // But re-filter to ensure accuracy in case data was updated
            let weekEvents = [];
            if (currentEvents && currentEvents.length > 0) {
                weekEvents = currentEvents.filter(event => {
                    // Use < instead of <= to get exactly 7 days (not 8)
                    return event.date >= todayStr && event.date < nextWeekStr;
                });
            }

            const count = weekEvents.length;

            // Count unique venues
            const uniqueVenues = new Set();
            weekEvents.forEach(event => {
                if (event.venue && event.venue.name) {
                    // Use venue name + address to identify unique locations
                    const venueKey = `${event.venue.name}|${event.venue.address || ''}`;
                    uniqueVenues.add(venueKey);
                }
            });

            const venueCount = uniqueVenues.size;

            // Display both venue count and event count
            dateRangeEl.innerHTML = `<strong>${venueCount.toLocaleString()} venues</strong> ‚Ä¢ ${count.toLocaleString()} events`;

            // Update page title and meta description with current stats
            updatePageMeta(venueCount, count);
        }

        // Update page title and meta tags with current stats
        function updatePageMeta(venueCount, eventCount) {
            // Keep title and meta tags static for Google Analytics consistency
            // Only update About modal counts (if they exist)

            // Update About modal counts
            const aboutVenueEl = document.getElementById('about-venue-count');
            if (aboutVenueEl) {
                aboutVenueEl.textContent = venueCount.toLocaleString();
            }

            const aboutEventEl = document.getElementById('about-event-count');
            if (aboutEventEl) {
                aboutEventEl.textContent = eventCount.toLocaleString();
            }

            console.log(`üìä Stats: ${venueCount} venues, ${eventCount} events (meta tags kept static)`);
        }

        // Mix events to ensure variety from all sources
        function mixEventSources(events) {
            // Don't mix - just return events in their sorted order
            // The events are already sorted by date, time, and age-specificity
            // Mixing would destroy the careful age-group sorting
            return events;
        }

        // Load events
        async function loadEvents() {
            try {
                // Add cache-busting parameter to force fresh data
                const cacheBuster = new Date().getTime();
                const response = await fetch(`./events.json?v=${cacheBuster}`);
                if (!response.ok) throw new Error('Failed to fetch');

                const data = await response.json();

                // Handle new format with metadata
                if (data.events && Array.isArray(data.events)) {
                    events = data.events;
                    window.eventsGeneratedAt = data.generated_at;
                } else {
                    // Fallback for old format
                    events = data;
                }
                console.log('Loaded events:', events.length);

                // Get today's date and 7 days ahead
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Start of today

                const endOfWeek = new Date(today);
                endOfWeek.setDate(today.getDate() + 7); // 7 days from today
                endOfWeek.setHours(23, 59, 59, 999); // End of day

                const todayStr = today.toISOString().split('T')[0];
                const endOfWeekStr = endOfWeek.toISOString().split('T')[0];

                console.log('Looking for events from:', todayStr, 'to', endOfWeekStr);

                // Filter upcoming events (today through end of week)
                const upcomingEvents = events.filter(e => {
                    // Check if event is within date range
                    if (e.date < todayStr || e.date > endOfWeekStr) {
                        return false;
                    }

                    // For today's events, check if they've already ended
                    if (e.date === todayStr && e.end_time) {
                        const now = new Date();
                        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                        // If event has ended, don't show it
                        if (e.end_time < currentTime) {
                            console.log(`üóëÔ∏è Filtering out past event: "${e.title}" (ended at ${e.end_time}, current time: ${currentTime})`);
                            return false;
                        }
                    }

                    return true;
                }).sort((a, b) => {
                    // First: Sort by date
                    if (a.date !== b.date) {
                        return a.date > b.date ? 1 : -1;
                    }

                    // Second: Sort by time
                    const timeCompare = (a.start_time || '00:00').localeCompare(b.start_time || '00:00');
                    if (timeCompare !== 0) {
                        return timeCompare;
                    }

                    // Third: No age-based sorting on initial load (default is "All Ages" filter)
                    // Age sorting only happens when user selects a specific age
                    return 0;
                });

                console.log('Upcoming events this week:', upcomingEvents.length);

                // Mix up events to avoid consecutive same-type events
                const mixedEvents = mixEventSources(upcomingEvents);

                // Show events or helpful message
                if (mixedEvents.length > 0) {
                    currentEvents = mixedEvents; // Store all events
                    displayedCount = 20; // Reset display count
                    // Sort by distance if user location available, otherwise by date/time
                    allFilteredEvents = sortEventsByDistance([...currentEvents]);
                    const eventsToShow = allFilteredEvents.slice(0, displayedCount);

                    // Update date range header with currently displayed events
                    updateDateRangeHeader(allFilteredEvents);

                    displayTodayEvents(eventsToShow);

                    // Update Event schema with current events
                    updateEventSchema(eventsToShow);

                    // Enable search input now that events are loaded
                    const searchInput = document.getElementById('search-input');
                    if (searchInput) {
                        searchInput.disabled = false;
                        searchInput.placeholder = 'Search venues, neighborhoods, keywords...';
                    }

                    // Show/hide "Show More" button
                    if (allFilteredEvents.length > displayedCount) {
                        document.getElementById('show-more-container').style.display = 'block';
                    } else {
                        document.getElementById('show-more-container').style.display = 'none';
                    }
                } else {
                    const container = document.getElementById('today-events');
                    container.innerHTML = '<div style="background: linear-gradient(135deg, #FFECB3 0%, #FFF8DC 100%); padding: 40px; border-radius: 20px; text-align: center; color: #000; font-weight: 700; font-size: 1.2rem; border: 4px solid white; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);">üéâ Weekend events coming soon! Check back later today for updates. We refresh events daily!</div>';
                }
            } catch (error) {
                console.error('Error loading events:', error);
                const container = document.getElementById('today-events');
                container.innerHTML = '<div style="background: linear-gradient(135deg, #FFB3D9 0%, #FFD9EC 100%); padding: 40px; border-radius: 20px; text-align: center; color: white; font-weight: 700; font-size: 1.2rem; border: 4px solid white; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);">‚ö†Ô∏è Having trouble loading events. Please refresh the page or try again later!</div>';
            }
        }

        // Distance cache to avoid redundant calculations
        const distanceCache = new Map();

        // TUNABLE: Walking distance multiplier for urban areas
        // Calibrated to match Google Maps walking distances for Toronto
        // Based on testing: St. Helen (1.18x), Creating Together (1.46x), 38 Shirley (1.79x) = avg 1.48x
        // Using 1.5x for better accuracy across varying Toronto walking routes
        const WALKING_DISTANCE_MULTIPLIER = 1.875;

        // Calculate distance from user to event using Haversine formula
        function calculateDistanceHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const straightLineDistance = R * c;
            return straightLineDistance;
        }

        // Calculate walking distance (uses Haversine with urban multiplier)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Validate inputs
            if (!lat1 || !lon1 || !lat2 || !lon2 ||
                isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
                console.error('Invalid coordinates for distance calculation:', {lat1, lon1, lat2, lon2});
                return null;
            }

            const cacheKey = `${lat1},${lon1}-${lat2},${lon2}`;

            // Check cache first
            if (distanceCache.has(cacheKey)) {
                return distanceCache.get(cacheKey);
            }

            // Calculate straight-line distance
            const straightLine = calculateDistanceHaversine(lat1, lon1, lat2, lon2);

            // Validate calculation result
            if (isNaN(straightLine) || straightLine < 0) {
                console.error('Invalid Haversine result:', straightLine);
                return null;
            }

            // Apply multiplier for urban walking routes
            // Accounts for Toronto's grid streets, sidewalks, crosswalks, and detours
            const walkingDistance = straightLine * WALKING_DISTANCE_MULTIPLIER;

            // Cache the result
            distanceCache.set(cacheKey, walkingDistance);

            return walkingDistance;
        }

        // Generate and update Event schema markup (JSON-LD)
        function updateEventSchema(events) {
            // Remove existing schema if present
            const existingSchema = document.getElementById('event-schema');
            if (existingSchema) {
                existingSchema.remove();
            }

            // Limit to first 30 events to keep schema reasonable size
            const eventsForSchema = (events || []).slice(0, 30);

            if (eventsForSchema.length === 0) return;

            // Generate Event schema for each event
            const eventSchemas = eventsForSchema.map(event => {
                const schema = {
                    "@context": "https://schema.org",
                    "@type": "Event",
                    "name": event.title,
                    "description": event.description || event.title,
                    "startDate": `${event.date}T${event.start_time || '00:00'}`,
                    "eventStatus": "https://schema.org/EventScheduled",
                    "eventAttendanceMode": event.indoor_outdoor === 'Outdoor'
                        ? "https://schema.org/OfflineEventAttendanceMode"
                        : "https://schema.org/OfflineEventAttendanceMode",
                    "location": {
                        "@type": "Place",
                        "name": event.venue.name,
                        "address": {
                            "@type": "PostalAddress",
                            "streetAddress": event.venue.address || "",
                            "addressLocality": "Toronto",
                            "addressRegion": "ON",
                            "addressCountry": "CA"
                        }
                    },
                    "organizer": {
                        "@type": "Organization",
                        "name": event.organized_by || "Toronto Kids Events"
                    }
                };

                // Add end time if available
                if (event.end_time) {
                    schema.endDate = `${event.date}T${event.end_time}`;
                }

                // Add coordinates if available
                if (event.venue.lat && event.venue.lng) {
                    schema.location.geo = {
                        "@type": "GeoCoordinates",
                        "latitude": event.venue.lat,
                        "longitude": event.venue.lng
                    };
                }

                // Add URL if available
                if (event.website) {
                    schema.url = event.website;
                }

                // Add offers (free or paid)
                schema.offers = {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "CAD",
                    "availability": "https://schema.org/InStock",
                    "url": event.website || "https://joshuaopolko.com/kidsevents/"
                };

                return schema;
            });

            // Create script tag with JSON-LD
            const script = document.createElement('script');
            script.type = 'application/ld+json';
            script.id = 'event-schema';
            script.textContent = JSON.stringify(eventSchemas, null, 2);
            document.head.appendChild(script);

            console.log(`‚úÖ Updated Event schema with ${eventSchemas.length} events`);
        }

        function displayTodayEvents(todayEvents) {
            const container = document.getElementById('today-events');

            if (!todayEvents || todayEvents.length === 0) {
                // Check if we're actively filtering/searching
                if (searchQuery.trim() !== '') {
                    container.innerHTML = `<div style="background: white; padding: 30px; border-radius: 20px; text-align: center; color: #000;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 10px;">No events found for "${searchQuery}"</div>
                        <div style="color: #6B7280; font-size: 0.95rem;">Try a different search term or <button onclick="document.getElementById('clear-search-btn').click()" style="color: #6366F1; text-decoration: underline; background: none; border: none; cursor: pointer; font-size: 0.95rem; padding: 0;">clear the search</button></div>
                    </div>`;
                } else {
                    container.innerHTML = '<div style="background: white; padding: 30px; border-radius: 20px; text-align: center; color: #000; font-weight: 700; font-size: 1.1rem;">üìÖ Loading fresh events... Please wait!</div>';
                }
                return;
            }

            container.innerHTML = todayEvents.map(event => {
                // Check if this is a special event (targeted, artisan, or unique)
                const targetedSources = ['TargetedAudiences'];
                const artisanSources = ['Artisans'];
                const uniqueEventSources = ['HolisticCommunity', 'Community', 'ChatterBlock', 'Museums', 'FamilyFun', 'ToDoCanada'];
                const isTemporal = targetedSources.includes(event.source) || artisanSources.includes(event.source) || uniqueEventSources.includes(event.source);

                let distanceHtml = '';
                if (userLocation && event.venue.lat && event.venue.lng) {
                    const distance = calculateDistance(
                        userLocation.lat,
                        userLocation.lng,
                        event.venue.lat,
                        event.venue.lng
                    );
                    // Only show distance if valid and > 0.05 km (prevents showing 0.0 km)
                    if (distance !== null && !isNaN(distance) && distance >= 0.05) {
                        distanceHtml = `<span style="display: inline-flex; align-items: center; gap: 4px;">${icon('location-arrow')} <span>~${distance.toFixed(1)} km</span></span>`;
                    }
                }

                // Get phone number - check event-specific first, then fall back to organizer defaults
                let phoneNumber = '';
                const organizer = event.organized_by || '';

                // First priority: event-specific phone numbers
                if (event.phone) {
                    phoneNumber = event.phone;
                } else if (event.venue && event.venue.phone) {
                    phoneNumber = event.venue.phone;
                // Second priority: organizer defaults
                } else if (organizer.includes('Toronto Public Library') || event.source === 'TPL') {
                    phoneNumber = '416-393-7131';
                } else if (organizer.includes('Royal Ontario Museum') || organizer.includes('ROM')) {
                    phoneNumber = '416-586-8000';
                } else if (organizer.includes('Art Gallery of Ontario') || organizer.includes('AGO')) {
                    phoneNumber = '416-979-6648';
                } else if (organizer.includes('Harbourfront Centre')) {
                    phoneNumber = '416-973-4000';
                } else if (organizer.includes('Ontario Science Centre')) {
                    phoneNumber = '416-696-1000';
                }
                // No fallback to 311 - only show phone if we have a direct number

                // Create map URL - prefer Place ID for direct, unambiguous linking
                let mapUrl;

                if (event.venue.place_id) {
                    // Best: Use Place ID for direct link to specific place (no ambiguity)
                    // Include venue name as query for better UX and fallback
                    const venueName = encodeURIComponent(event.venue.name);
                    mapUrl = `https://www.google.com/maps/search/?api=1&query=${venueName}&query_place_id=${event.venue.place_id}`;
                } else {
                    // Fallback: Use search query if Place ID not available
                    let searchQuery;
                    const hasStreetAddress = event.venue.address && /\d/.test(event.venue.address);

                    if (hasStreetAddress && event.venue.name) {
                        const addressHasLocation = event.venue.address.includes('ON') || /[A-Z]\d[A-Z]\s*\d[A-Z]\d/.test(event.venue.address);
                        if (addressHasLocation) {
                            searchQuery = `${event.venue.name}, ${event.venue.address}`;
                        } else {
                            searchQuery = `${event.venue.name}, ${event.venue.address}, Toronto, ON, Canada`;
                        }
                    } else if (hasStreetAddress) {
                        const addressHasLocation = event.venue.address.includes('ON') || /[A-Z]\d[A-Z]\s*\d[A-Z]\d/.test(event.venue.address);
                        if (addressHasLocation) {
                            searchQuery = `${event.venue.address}`;
                        } else {
                            searchQuery = `${event.venue.address}, Toronto, ON, Canada`;
                        }
                    } else if (event.venue.name) {
                        let venueName = event.venue.name;
                        if (venueName.includes('Toronto Public Library -')) {
                            const branchName = venueName.split('-')[1].trim();
                            searchQuery = `${branchName} Library Toronto`;
                        } else if (venueName.includes('Community Centre') || venueName.includes('Recreation Centre')) {
                            searchQuery = `${venueName}, Toronto, ON, Canada`;
                        } else {
                            searchQuery = `${venueName}, Toronto, ON, Canada`;
                        }
                    } else {
                        searchQuery = `${event.venue.neighborhood}, Toronto, ON, Canada`;
                    }

                    mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
                }

                // Action buttons
                let actionsHtml = `<div class="event-actions">
                    <a href="${mapUrl}" target="_blank" rel="noopener" class="event-btn">
                        ${icon('map-marker-alt')} Map
                    </a>`;

                // Only show info button if there's a specific URL (not generic domain)
                if (event.website) {
                    // Fix URLs missing protocol (e.g., "www.tcdsb.org" -> "https://www.tcdsb.org")
                    let websiteUrl = event.website;
                    if (!websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                        websiteUrl = 'https://' + websiteUrl;
                    }

                    const genericUrls = [
                        'https://www.toronto.ca',
                        'http://www.toronto.ca',
                        'https://www.oakville.ca',
                        'http://www.oakville.ca',
                        'https://harbourfrontcentre.com',
                        'http://harbourfrontcentre.com',
                        'https://www.chatterblock.com',
                        'http://www.chatterblock.com'
                    ];

                    // Also check for generic parks & rec URLs
                    const isGenericParksUrl = websiteUrl.includes('toronto.ca/data/parks/prd/index.html') ||
                                             websiteUrl.includes('toronto.ca/data/parks/prd/facilities/complex');

                    // Check if it's not just a generic domain or generic parks URL
                    const isSpecific = !genericUrls.includes(websiteUrl) && !isGenericParksUrl;

                    if (isSpecific) {
                        // Determine button label based on source
                        let buttonLabel = 'Details';
                        let buttonIconName = 'info-circle';

                        if (event.source === 'TPL') {
                            buttonLabel = 'TPL Page';
                            buttonIconName = 'book';
                        } else if (event.source === 'Museums' || event.source === 'MuseumFreeDays') {
                            buttonLabel = 'Museum';
                            buttonIconName = 'landmark';
                        } else if (event.source === 'EventBrite') {
                            buttonLabel = 'EventBrite';
                            buttonIconName = 'ticket-alt';
                        } else if (event.source === 'ChatterBlock') {
                            buttonLabel = 'ChatterBlock';
                            buttonIconName = 'calendar-alt';
                        } else if (event.source === 'HolisticCommunity') {
                            buttonLabel = 'Website';
                            buttonIconName = 'leaf';
                        } else if (event.source === 'Community') {
                            buttonLabel = 'Website';
                            buttonIconName = 'external-link-alt';
                        }

                        actionsHtml += `
                        <a href="${websiteUrl}" target="_blank" rel="noopener" class="event-btn">
                            ${icon(buttonIconName)} ${buttonLabel}
                        </a>`;
                    }
                }

                actionsHtml += `</div>`;

                // Organizer info
                let organizerHtml = '';
                if (event.organized_by) {
                    organizerHtml = `<div class="event-organizer">
                        ${icon('user-circle')} ${event.organized_by}
                    </div>`;
                }

                // Create calendar event data
                const calendarTitle = encodeURIComponent(event.title);
                const calendarDetails = encodeURIComponent(event.description || '');
                const calendarLocation = encodeURIComponent(`${event.venue.name}, ${event.venue.address || event.venue.neighborhood}`);
                const startDateTime = `${event.date.replace(/-/g, '')}T${event.start_time.replace(':', '')}00`;
                const endDateTime = `${event.date.replace(/-/g, '')}T${event.end_time.replace(':', '')}00`;
                const googleCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${calendarTitle}&dates=${startDateTime}/${endDateTime}&details=${calendarDetails}&location=${calendarLocation}`;

                // Share text
                const shareText = encodeURIComponent(`${event.title} - Toronto Kids Event`);
                const shareUrl = encodeURIComponent(window.location.href);

                // Price badge - only show FREE tag for free events, no tag for paid events
                let priceBadge = '';
                if (event.is_free === true || event.is_free === undefined) {
                    // Show FREE tag for confirmed free events or unspecified (default to free)
                    // Using solid green background with text-shadow for better readability
                    priceBadge = '<span style="background: #7FD4AA; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 900; margin-left: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); letter-spacing: 0.5px;">FREE</span>';
                }
                // For paid events (is_free === false), show no badge

                return `
                    <div class="event ${isTemporal ? 'temporal' : ''}" data-event-id="${event.id}">
                        <div class="event-header">
                            <div class="event-main">
                                <div class="event-title">
                                    ${event.title}
                                    ${priceBadge}
                                </div>
                                <div class="event-meta">
                                    ${(() => {
                                        const eventDate = new Date(event.date + 'T' + event.start_time);
                                        const dateStr = eventDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                                        const startTime = formatTime12Hour(event.start_time);
                                        const endTime = event.end_time ? formatTime12Hour(event.end_time) : '';

                                        // Create prominent date/time badge
                                        let dateTimeHtml = `<span style="font-weight: 800; background: white; color: #000; padding: 6px 14px; border-radius: 10px; border: 2px solid #8B9DC3; margin-right: 6px; white-space: nowrap; font-size: 1.05rem;">${dateStr}</span>`;

                                        // Add time range as separate prominent badge
                                        if (endTime) {
                                            dateTimeHtml += `<span style="font-weight: 800; background: linear-gradient(135deg, #A0E7E0 0%, #88CFC0 100%); color: white; padding: 6px 14px; border-radius: 10px; margin-right: 6px; white-space: nowrap; font-size: 1.05rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${icon('clock')} ${startTime} - ${endTime}</span>`;
                                        } else {
                                            dateTimeHtml += `<span style="font-weight: 800; background: linear-gradient(135deg, #A0E7E0 0%, #88CFC0 100%); color: white; padding: 6px 14px; border-radius: 10px; margin-right: 6px; white-space: nowrap; font-size: 1.05rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${icon('clock')} ${startTime}</span>`;
                                        }

                                        return dateTimeHtml;
                                    })()}
                                    ${phoneNumber ? `<span style="font-weight: 800; font-size: 1.15rem;"><a href="tel:${phoneNumber}" style="color: #000; text-decoration: none; background: white; padding: 4px 12px; border-radius: 10px; border: 2px solid #8B9DC3; display: inline-flex; align-items: center; gap: 6px; margin-right: 6px;">${icon('phone')} ${phoneNumber}</a></span>` : ''}
                                    <span style="margin-right: 6px;">${icon('map-marker-alt')} ${event.venue.name || event.venue.neighborhood}</span>
                                    <span style="margin-right: 6px;">${event.icon} ${event.category}</span>
                                    ${distanceHtml ? `<span style="font-weight: 800; color: #000; background: white; padding: 6px 12px; border-radius: 10px; border: 2px solid #8B9DC3; white-space: nowrap; display: inline-flex; align-items: center; gap: 6px;">${distanceHtml.replace(/<\/?span[^>]*>/g, '')}</span>` : ''}
                                </div>
                                ${organizerHtml}
                            </div>
                            ${actionsHtml}
                        </div>

                        ${(() => {
                            // Only show description if it's meaningful (not just the title repeated)
                            if (!event.description) return '';
                            const desc = event.description.trim();
                            const title = event.title.trim();
                            // Check if description is just the title or contains only the title
                            if (desc.toLowerCase() === title.toLowerCase()) return '';
                            if (desc.toLowerCase().replace(/[^a-z0-9\s]/g, '') === title.toLowerCase().replace(/[^a-z0-9\s]/g, '')) return '';
                            // If description is very short and similar, skip it
                            if (desc.length < 20 && desc.toLowerCase().includes(title.toLowerCase().split(' ')[0])) return '';

                            // Show truncated description with "Read more" if longer than 150 words
                            const words = desc.split(/\s+/);
                            const wordLimit = 150;

                            if (words.length > wordLimit) {
                                // Truncate to first 150 words
                                const truncated = words.slice(0, wordLimit).join(' ');
                                const descId = 'desc-' + event.id;
                                return `
                                    <div class="event-description" style="margin-top: 15px;">
                                        <span id="${descId}-short">${truncated}... <button onclick="toggleDescription('${descId}')" style="color: #3B82F6; background: none; border: none; cursor: pointer; text-decoration: underline; font-weight: 700; padding: 0;">Read more</button></span>
                                        <span id="${descId}-full" style="display: none;">${desc} <button onclick="toggleDescription('${descId}')" style="color: #3B82F6; background: none; border: none; cursor: pointer; text-decoration: underline; font-weight: 700; padding: 0;">Read less</button></span>
                                    </div>
                                `;
                            }
                            return `<div class="event-description" style="margin-top: 15px;">${desc}</div>`;
                        })()}

                        <div class="event-extra-info" style="margin-top: 15px;">
                            ${event.age_groups && event.age_groups.length ? `<div class="info-tag">${icon('users')} ${event.age_groups.join(', ')}</div>` : ''}
                            ${event.indoor_outdoor ? `<div class="info-tag">${icon(event.indoor_outdoor === 'Outdoor' ? 'sun' : 'home')} ${event.indoor_outdoor}</div>` : ''}
                            ${event.venue.address ? `<div class="info-tag">${icon('location-dot')} ${event.venue.address}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Don't automatically update distances - only when explicitly requested
            // This saves API calls and costs
        }

        // Toggle description expand/collapse
        function toggleDescription(descId) {
            const shortEl = document.getElementById(descId + '-short');
            const fullEl = document.getElementById(descId + '-full');

            if (shortEl && fullEl) {
                if (shortEl.style.display === 'none') {
                    // Currently showing full, switch to short
                    shortEl.style.display = 'inline';
                    fullEl.style.display = 'none';
                } else {
                    // Currently showing short, switch to full
                    shortEl.style.display = 'none';
                    fullEl.style.display = 'inline';
                }
            }
        }

        // No longer needed - distances are calculated instantly using Haversine
        // This function remains for backwards compatibility but does nothing
        async function updateDistancesAsync(events) {
            // Distances are already calculated using Haversine formula
            // No API calls needed - instant and free!
            console.log(`üìç Using Haversine distance formula with ${WALKING_DISTANCE_MULTIPLIER}x multiplier for ${events.length} events`);
        }

        // Sort events by distance
        function sortEventsByDistance(events, selectedAgeGroup = null) {
            if (!userLocation) {
                // If no user location, fall back to date/time sorting
                return sortEventsByDateTime(events, selectedAgeGroup);
            }

            return events.sort((a, b) => {
                // First priority: sort by date
                if (a.date !== b.date) {
                    return a.date > b.date ? 1 : -1;
                }

                // Second priority: ALWAYS push "All Ages ONLY" events to bottom (unless that's the selected filter)
                const aIsOnlyAllAges = a.age_groups && a.age_groups.length === 1 && a.age_groups[0] === 'All Ages';
                const bIsOnlyAllAges = b.age_groups && b.age_groups.length === 1 && b.age_groups[0] === 'All Ages';

                if (selectedAgeGroup !== 'all') {
                    if (aIsOnlyAllAges && !bIsOnlyAllAges) return 1;  // a goes to bottom
                    if (!aIsOnlyAllAges && bIsOnlyAllAges) return -1; // b goes to bottom
                }

                // Third priority: sort by distance
                const distA = a.venue && a.venue.lat && a.venue.lng
                    ? calculateDistance(userLocation.lat, userLocation.lng, a.venue.lat, a.venue.lng)
                    : 999999;
                const distB = b.venue && b.venue.lat && b.venue.lng
                    ? calculateDistance(userLocation.lat, userLocation.lng, b.venue.lat, b.venue.lng)
                    : 999999;

                if (Math.abs(distA - distB) > 0.1) {
                    return distA - distB;
                }

                // Fourth priority: sort by time (for events at similar distances)
                const timeCompare = (a.start_time || '00:00').localeCompare(b.start_time || '00:00');
                if (timeCompare !== 0) {
                    return timeCompare;
                }

                // Fifth priority: when a specific age is selected, prioritize events with that exact age
                if (selectedAgeGroup && selectedAgeGroup !== 'all') {
                    const aHasSelectedAge = a.age_groups && a.age_groups.includes(selectedAgeGroup);
                    const bHasSelectedAge = b.age_groups && b.age_groups.includes(selectedAgeGroup);

                    if (aHasSelectedAge && !bHasSelectedAge) return -1;
                    if (!aHasSelectedAge && bHasSelectedAge) return 1;
                }

                return 0;
            });
        }

        // Sort events by date and time
        function sortEventsByDateTime(events, selectedAgeGroup = null) {
            const sorted = events.sort((a, b) => {
                // First priority: sort by date
                if (a.date !== b.date) {
                    return a.date > b.date ? 1 : -1;
                }

                // Second priority: ALWAYS push "All Ages ONLY" events to bottom (unless that's the selected filter)
                const aIsOnlyAllAges = a.age_groups && a.age_groups.length === 1 && a.age_groups[0] === 'All Ages';
                const bIsOnlyAllAges = b.age_groups && b.age_groups.length === 1 && b.age_groups[0] === 'All Ages';

                if (selectedAgeGroup !== 'all') {
                    if (aIsOnlyAllAges && !bIsOnlyAllAges) return 1;  // a goes to bottom
                    if (!aIsOnlyAllAges && bIsOnlyAllAges) return -1; // b goes to bottom
                }

                // Third priority: sort by time
                return (a.start_time || '00:00') > (b.start_time || '00:00') ? 1 : -1;
            });

            return sorted;
        }

        // Get user location (with timeout to avoid blocking)
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('User location:', userLocation);
                        // Re-sort existing events by distance (don't reload from file)
                        filterEventsByAge('all');

                        // Now update distances with Google Distance Matrix API
                        // This only happens once when user clicks "Near Me"
                        console.log('üìç Calculating accurate walking distances...');
                        updateDistancesAsync(allFilteredEvents.slice(0, displayedCount));
                    },
                    (error) => {
                        console.log('Location access denied or unavailable');
                    },
                    { timeout: 5000, maximumAge: 300000 } // 5s timeout, cache for 5 min
                );
            }
        }

        // Show more events (load next 20)
        function showMoreEvents() {
            displayedCount += 20;
            const eventsToShow = allFilteredEvents.slice(0, displayedCount);
            displayTodayEvents(eventsToShow);
            updateEventSchema(eventsToShow);

            // Hide button if we've shown all events
            if (displayedCount >= allFilteredEvents.length) {
                document.getElementById('show-more-container').style.display = 'none';
            }
        }

        // Filter events by age group
        function filterEventsByAge(ageGroup) {
            console.log('Filtering by age:', ageGroup, 'Search:', searchQuery);

            // Safety check: ensure events are loaded
            if (!currentEvents || currentEvents.length === 0) {
                console.warn('Events not loaded yet, skipping filter');
                return;
            }

            displayedCount = 20; // Reset display count

            // Calculate next 7 days date range
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            const todayStr = today.toISOString().split('T')[0];
            const nextWeekStr = nextWeek.toISOString().split('T')[0];

            let filtered = [];

            if (ageGroup === 'all') {
                // Show all events in next 7 days
                filtered = currentEvents.filter(event => {
                    // Must be in next 7 days
                    if (event.date < todayStr || event.date >= nextWeekStr) return false;

                    // For today's events, check if they've already ended
                    if (event.date === todayStr && event.end_time) {
                        const now = new Date();
                        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                        if (event.end_time < currentTime) {
                            return false;
                        }
                    }

                    return true;
                });
            } else {
                // Filter by BOTH age group AND next 7 days
                filtered = currentEvents.filter(event => {
                    // First check: must be in next 7 days
                    if (event.date < todayStr || event.date >= nextWeekStr) return false;

                    // For today's events, check if they've already ended
                    if (event.date === todayStr && event.end_time) {
                        const now = new Date();
                        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                        if (event.end_time < currentTime) {
                            return false;
                        }
                    }

                    if (!event.age_groups || event.age_groups.length === 0) return false;

                    // Include "All Ages" events
                    if (event.age_groups.includes('All Ages')) return true;

                    // Include if this specific age group is listed
                    if (event.age_groups.includes(ageGroup)) return true;

                    // Exclude events that don't include this age
                    return false;
                });
            }

            // Apply search filter if active
            if (searchQuery.trim() !== '') {
                const query = searchQuery.toLowerCase().trim();
                console.log(`Searching for: "${query}" in ${filtered.length} events`);

                // Normalize search query - remove common suffixes for better matching
                const normalizeWord = (word) => {
                    return word
                        .replace(/ing$/i, '')  // swimming -> swim, playing -> play
                        .replace(/es$/i, '')   // beaches -> beach (must come before -s)
                        .replace(/s$/i, '');   // arts -> art, parks -> park
                };

                const normalizedQuery = normalizeWord(query);

                // Function to check if text matches query (with word variation support)
                const textMatches = (text) => {
                    if (!text) return false;
                    const lowerText = text.toLowerCase();

                    // First, try exact substring match for both original and normalized query
                    if (lowerText.includes(query)) return true;
                    if (lowerText.includes(normalizedQuery)) return true;

                    // For short queries (‚â§4 chars), require whole-word matches to avoid false positives
                    // e.g., "east" shouldn't match "Toronto and East York" (East is part of district name)
                    const isShortQuery = query.length <= 4;

                    // Tokenize text into words (removing punctuation)
                    const textWords = lowerText.split(/[\s,.:;!?()[\]{}'"]+/).filter(w => w.length >= 2);

                    // Tokenize query into words
                    const queryWords = query.split(/\s+/).filter(w => w.length >= 2);

                    // Check each query word against each text word
                    for (const queryWord of queryWords) {
                        const normalizedQueryWord = normalizeWord(queryWord);

                        for (const textWord of textWords) {
                            const normalizedTextWord = normalizeWord(textWord);

                            if (isShortQuery) {
                                // For short queries, require exact match after normalization
                                if (normalizedTextWord === normalizedQueryWord || normalizedTextWord === queryWord) {
                                    return true;
                                }
                            } else {
                                // For longer queries:
                                // 1. Check if normalized words match
                                if (normalizedTextWord === normalizedQueryWord) return true;

                                // 2. Check if text word starts with query word (swim matches swimming)
                                if (normalizedTextWord.startsWith(normalizedQueryWord)) return true;

                                // 3. Check if query word starts with text word (swimming matches swim)
                                // BUT only for words of reasonable length (4+ chars) to avoid false positives
                                // e.g., prevent "burlington" from matching "by" or "bur"
                                if (normalizedTextWord.length >= 4 && normalizedQueryWord.startsWith(normalizedTextWord)) return true;
                            }
                        }
                    }

                    return false;
                };

                const beforeCount = filtered.length;
                filtered = filtered.filter(event => {
                    try {
                        // Search in indoor/outdoor field (e.g., "outdoor", "indoor", "both")
                        if (textMatches(event.indoor_outdoor)) return true;

                        // Search in title
                        if (textMatches(event.title)) return true;

                        // Search in description
                        if (textMatches(event.description)) return true;

                        // Search in venue name
                        if (textMatches(event.venue?.name)) return true;

                        // Search in address
                        if (textMatches(event.venue?.address)) return true;

                        // Skip neighborhood for very short queries (‚â§4 chars) to avoid matching district names
                        // e.g., "east" shouldn't match all "Toronto and East York" events
                        // For neighborhood search, only match if searching for multiple words that match
                        // the compound name, or if matching a non-hyphenated neighborhood name
                        // This prevents "Agincourt" from matching all "SCARBOROUGH-AGINCOURT" events
                        if (query.length > 4 && event.venue?.neighborhood) {
                            const neighborhood = event.venue.neighborhood.toLowerCase();

                            // If searching for multiple words (e.g., "scarborough agincourt"), match the full area
                            if (query.includes(' ')) {
                                if (textMatches(neighborhood)) return true;
                            }
                            // For single-word queries, only match if:
                            // 1. The neighborhood name has no hyphen (simple neighborhood)
                            // 2. The query exactly matches the entire neighborhood name
                            else {
                                if (!neighborhood.includes('-')) {
                                    // Simple neighborhood name - allow partial matching
                                    if (textMatches(neighborhood)) return true;
                                } else {
                                    // Hyphenated ward name - require exact full match only
                                    // This prevents "Agincourt" matching "SCARBOROUGH-AGINCOURT"
                                    if (neighborhood === query || neighborhood === normalizedQuery) {
                                        return true;
                                    }
                                }
                            }
                        }

                        // Search in organizer
                        if (textMatches(event.organized_by)) return true;

                        // Search in category
                        if (textMatches(event.category)) return true;

                        return false;
                    } catch (error) {
                        console.error('Error filtering event:', error, event);
                        return false;
                    }
                });
                console.log(`Search results: ${filtered.length} events (filtered out ${beforeCount - filtered.length})`);
            }

            console.log(`Sorting ${filtered.length} events...`);
            allFilteredEvents = sortEventsByDistance(filtered, ageGroup);
            console.log(`Sorted. Displaying first ${Math.min(displayedCount, allFilteredEvents.length)} events`);
            const eventsToShow = allFilteredEvents.slice(0, displayedCount);

            // Update date range header with currently displayed events
            updateDateRangeHeader(allFilteredEvents);

            const dateRangeEl = document.getElementById('week-range');

            // Helper function to count unique venues
            const countUniqueVenues = (events) => {
                const uniqueVenues = new Set();
                events.forEach(event => {
                    if (event.venue && event.venue.name) {
                        const venueKey = `${event.venue.name}|${event.venue.address || ''}`;
                        uniqueVenues.add(venueKey);
                    }
                });
                return uniqueVenues.size;
            };

            // Priority: Search > Age Filter > Weekly Total
            if (searchQuery.trim() !== '') {
                // Show search result count with unique venues
                if (dateRangeEl && allFilteredEvents.length > 0) {
                    const venueCount = countUniqueVenues(allFilteredEvents);
                    dateRangeEl.innerHTML = `Found <strong>${venueCount} ${venueCount === 1 ? 'venue' : 'venues'}</strong> ‚Ä¢ ${allFilteredEvents.length} ${allFilteredEvents.length === 1 ? 'event' : 'events'} for "${searchQuery}"`;
                }
            } else if (ageGroup && ageGroup !== 'all') {
                // Show age filter result count with unique venues (always next 7 days)
                if (dateRangeEl) {
                    const venueCount = countUniqueVenues(allFilteredEvents);
                    dateRangeEl.innerHTML = `<strong>${venueCount.toLocaleString()} venues</strong> ‚Ä¢ ${allFilteredEvents.length.toLocaleString()} events`;
                    // Update page meta with filtered stats
                    updatePageMeta(venueCount, allFilteredEvents.length);
                }
            } else {
                // Show all ages event count (next 7 days) - this case is already handled by updateDateRangeHeader
                // But we keep this for consistency
                if (dateRangeEl) {
                    const venueCount = countUniqueVenues(allFilteredEvents);
                    dateRangeEl.innerHTML = `<strong>${venueCount.toLocaleString()} venues</strong> ‚Ä¢ ${allFilteredEvents.length.toLocaleString()} events`;
                    // Update page meta with all ages stats
                    updatePageMeta(venueCount, allFilteredEvents.length);
                }
            }

            displayTodayEvents(eventsToShow);
            updateEventSchema(eventsToShow);

            // Show/hide "Show More" button
            if (allFilteredEvents.length > displayedCount) {
                document.getElementById('show-more-container').style.display = 'block';
            } else {
                document.getElementById('show-more-container').style.display = 'none';
            }

            // Enable search input now that events are loaded
            const searchInput = document.getElementById('search-input');
            if (searchInput && searchInput.disabled) {
                searchInput.disabled = false;
                searchInput.placeholder = 'Search venues, neighborhoods, keywords...';
            }
        }

        // Modal functions
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Find any orphaned content div and move it back
                const contentDiv = document.body.querySelector(`[data-modal="${modalId}"]`);
                if (contentDiv) {
                    modal.appendChild(contentDiv);
                }
            }
        }

        function showAboutModal() {
            const modal = document.getElementById('about-modal');
            if (modal) {
                modal.style.display = 'block';
                modal.onclick = (e) => {
                    if (e.target === modal) closeModal('about-modal');
                };

                // Force the inner div to show
                const innerDiv = modal.querySelector('div');
                if (innerDiv) {
                    // Mark it so we can find it later
                    innerDiv.setAttribute('data-modal', 'about-modal');

                    // MOVE IT TO BODY - take it out of the modal parent
                    document.body.appendChild(innerDiv);

                    // Remove all inline styles first
                    innerDiv.removeAttribute('style');

                    // Calculate position based on current scroll
                    const scrollY = window.scrollY || window.pageYOffset;
                    const viewportHeight = window.innerHeight;
                    const topPosition = scrollY + (viewportHeight / 2);

                    // Set proper modal styles - use absolute positioning based on scroll
                    innerDiv.style.cssText = `position: absolute; top: ${topPosition}px; left: 50%; transform: translate(-50%, -50%); max-width: 700px; width: 90%; max-height: 85vh; background: white; border-radius: 24px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); z-index: 1000001; display: block; visibility: visible; opacity: 1; padding: 40px; overflow-y: auto;`;

                    // Add close button if not exists
                    if (!innerDiv.querySelector('.modal-close-btn')) {
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'modal-close-btn';
                        closeBtn.innerHTML = '&times;';
                        closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: #f3f4f6; border: none; font-size: 28px; cursor: pointer; color: #000; font-weight: bold; width: 40px; height: 40px; border-radius: 50%;';
                        closeBtn.onclick = (e) => {
                            e.stopPropagation();
                            closeModal('about-modal');
                        };
                        innerDiv.insertBefore(closeBtn, innerDiv.firstChild);
                    }
                }
            }
        }

        function showSourcesModal() {
            const modal = document.getElementById('sources-modal');
            if (modal) {
                modal.style.display = 'block';
                modal.onclick = (e) => {
                    if (e.target === modal) closeModal('sources-modal');
                };

                const innerDiv = modal.querySelector('div');
                if (innerDiv) {
                    innerDiv.setAttribute('data-modal', 'sources-modal');
                    document.body.appendChild(innerDiv);
                    innerDiv.removeAttribute('style');

                    const scrollY = window.scrollY || window.pageYOffset;
                    const viewportHeight = window.innerHeight;
                    const topPosition = scrollY + (viewportHeight / 2);

                    innerDiv.style.cssText = `position: absolute; top: ${topPosition}px; left: 50%; transform: translate(-50%, -50%); max-width: 700px; width: 90%; max-height: 85vh; background: white; border-radius: 24px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); z-index: 1000001; display: block; visibility: visible; opacity: 1; padding: 40px; overflow-y: auto;`;
                    if (!innerDiv.querySelector('.modal-close-btn')) {
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'modal-close-btn';
                        closeBtn.innerHTML = '&times;';
                        closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: #f3f4f6; border: none; font-size: 28px; cursor: pointer; color: #000; font-weight: bold; width: 40px; height: 40px; border-radius: 50%;';
                        closeBtn.onclick = (e) => {
                            e.stopPropagation();
                            closeModal('sources-modal');
                        };
                        innerDiv.insertBefore(closeBtn, innerDiv.firstChild);
                    }
                }
            }
        }

        function showContactModal() {
            const modal = document.getElementById('contact-modal');
            if (modal) {
                modal.style.display = 'block';
                modal.onclick = (e) => {
                    if (e.target === modal) closeModal('contact-modal');
                };

                const innerDiv = modal.querySelector('div');
                if (innerDiv) {
                    innerDiv.setAttribute('data-modal', 'contact-modal');
                    document.body.appendChild(innerDiv);
                    innerDiv.removeAttribute('style');

                    const scrollY = window.scrollY || window.pageYOffset;
                    const viewportHeight = window.innerHeight;
                    const topPosition = scrollY + (viewportHeight / 2);

                    innerDiv.style.cssText = `position: absolute; top: ${topPosition}px; left: 50%; transform: translate(-50%, -50%); max-width: 600px; width: 90%; max-height: 85vh; background: white; border-radius: 24px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); z-index: 1000001; display: block; visibility: visible; opacity: 1; padding: 40px; overflow-y: auto;`;
                    if (!innerDiv.querySelector('.modal-close-btn')) {
                        const closeBtn = document.createElement('button');
                        closeBtn.className = 'modal-close-btn';
                        closeBtn.innerHTML = '&times;';
                        closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: #f3f4f6; border: none; font-size: 28px; cursor: pointer; color: #000; font-weight: bold; width: 40px; height: 40px; border-radius: 50%;';
                        closeBtn.onclick = (e) => {
                            e.stopPropagation();
                            closeModal('contact-modal');
                        };
                        innerDiv.insertBefore(closeBtn, innerDiv.firstChild);
                    }
                }
            }
        }

        // Initialize
        async function init() {
            console.log('Initializing...');

            // Don't show content yet - wait for load_events.js to load data
            // load_events.js will hide loading screen when ready

            // Don't get user location automatically - wait for user to click "Near Me"
            // getUserLocation();

            // Load events after showing content
            // NOTE: Events are now loaded via load_events.js (weekly files)
            // The weekly file loader will show content when ready

            // Setup age filter dropdown
            const ageFilterSelect = document.getElementById('age-filter-select');
            if (ageFilterSelect) {
                ageFilterSelect.addEventListener('change', function() {
                    const ageGroup = this.value;
                    filterEventsByAge(ageGroup);
                });
            }

            // Setup search input
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');

            if (searchInput) {
                // Real-time search with debounce
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    const value = this.value.trim();

                    // Show/hide clear button
                    if (clearSearchBtn) {
                        clearSearchBtn.style.display = value ? 'block' : 'none';
                    }

                    // Debounce search to avoid filtering on every keystroke
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchQuery = value;

                        // Re-apply filters with current age group
                        const ageFilterSelect = document.getElementById('age-filter-select');
                        const ageGroup = ageFilterSelect ? ageFilterSelect.value : 'all';
                        filterEventsByAge(ageGroup);
                    }, 300); // 300ms debounce
                });
            }

            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    searchQuery = '';
                    this.style.display = 'none';

                    // Re-apply filters with current age group
                    const ageFilterSelect = document.getElementById('age-filter-select');
                    const ageGroup = ageFilterSelect ? ageFilterSelect.value : 'all';
                    filterEventsByAge(ageGroup);
                });
            }

            // Handle Ctrl+Home to scroll to absolute top of page
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Home') {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            // Setup Near Me button
            const nearMeBtn = document.getElementById('near-me-btn');
            if (nearMeBtn) {
                nearMeBtn.addEventListener('click', function() {
                    this.textContent = 'üìç Loading...';
                    this.disabled = true;
                    getUserLocation();

                    // Re-enable after attempt
                    setTimeout(() => {
                        if (userLocation) {
                            this.textContent = 'üìç By Distance';
                            this.style.background = 'linear-gradient(135deg, #88CFC0 0%, #72C4B3 100%)';
                        } else {
                            this.textContent = 'üìç Near Me';
                            this.disabled = false;
                        }
                    }, 2000);
                });
            }
        }

        init();
    </script>

    <!-- About Modal -->
    <div id="about-modal" onclick="if(event.target.id==='about-modal') this.style.display='none'" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 999999; padding: 20px; overflow-y: scroll;">
        <div onclick="event.stopPropagation()">
                <h2 style="font-size: 2.5rem; font-weight: 900; color: #D81B60; margin-bottom: 16px; text-shadow: 2px 2px 4px rgba(216, 27, 96, 0.2);">About Toronto Kids Events</h2>
                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin-bottom: 16px;">Your Daily Guide to Kids Activities in Toronto</h3>
                <p style="margin-bottom: 16px; line-height: 1.8; color: #000;">Toronto Kids Events helps families discover amazing activities happening across Toronto and the GTA. Whether you're looking for library storytimes, community centre drop-ins, museum free days, or indoor play centres, we've got you covered.</p>
                <p style="margin-bottom: 16px; line-height: 1.8; color: #000;">Our platform aggregates programs from <strong><span id="about-venue-count">300+</span> venues</strong> across dozens of trusted sources and updates daily. Many venues host recurring programs throughout the week‚Äîso you'll see library storytimes, community drop-ins, and Parks & Rec programs happening at the same great locations multiple times per week.</p>
                <p style="margin-bottom: 16px; line-height: 1.8; color: #000;"><strong>Over 90% of programs are FREE!</strong> We feature <strong><span id="about-event-count">1,000+</span> programs</strong> this week with most being completely free. Events with a green "FREE" badge are confirmed free. Events without the badge may charge admission‚Äîcheck the venue's website for details.</p>
                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 16px;">What You'll Find:</h3>
                <p style="margin-bottom: 16px; line-height: 1.8; color: #000;">üìö <a href="https://www.torontopubliclibrary.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Toronto Public Library</a> events (storytimes, crafts, <a href="https://en.wikipedia.org/wiki/Science,_technology,_engineering,_and_mathematics" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">STEM</a> programs)<br>
                üèõÔ∏è Museum & gallery free admission days (<a href="https://www.rom.on.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">ROM</a>, <a href="https://ago.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">AGO</a>, <a href="https://www.ontariosciencecentre.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Science Centre</a>)<br>
                üé™ Community centre drop-in programs (playgroups, youth programs, gym time)<br>
                üå≥ <a href="https://www.toronto.ca/community-people/children-parenting/children-programs-activities/early-learning-child-care-centres/earlyon-child-family-centres/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">EarlyON</a> drop-in sessions for babies & toddlers<br>
                üèÉ <a href="https://www.toronto.ca/explore-enjoy/recreation/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Parks & Recreation</a> programs across Toronto<br>
                üé® Arts, cultural, and educational activities<br>
                üåø Nature programs and outdoor adventures<br>
                ü§∏ Indoor play centres & trampoline parks (paid admission)</p>
                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 16px;">Mostly Free. Always Family-Friendly. Updated Daily.</h3>
                <p style="margin-bottom: 16px; line-height: 1.8; color: #000;">We focus primarily on free events so families can enjoy Toronto's incredible community resources without breaking the bank. We also include popular paid venues like indoor playgrounds so you have all your options in one place. From babies to teens, there's something for every age group.</p>
                <p style="margin-top: 24px; font-weight: 600; color: #E91E63;">Ready to explore? Start browsing this week's events!</p>
        </div>
    </div>

    <!-- Data Sources Modal -->
    <div id="sources-modal" onclick="if(event.target.id==='sources-modal') this.style.display='none'" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 999999; padding: 20px; overflow-y: scroll;">
        <div onclick="event.stopPropagation()">
                <h2 style="font-size: 2.5rem; font-weight: 900; color: #D81B60; margin-bottom: 24px; text-shadow: 2px 2px 4px rgba(216, 27, 96, 0.2);">Data Sources</h2>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Toronto Kids Events aggregates information from trusted government, institutional, and community sources to provide comprehensive event listings for Toronto families. All data is updated daily to ensure accuracy.</p>

                <p style="margin-bottom: 24px; line-height: 1.8; color: #000; padding: 16px; background: linear-gradient(135deg, #FFF9C4 0%, #FFF3E0 100%); border-left: 4px solid #FFA726; border-radius: 8px;"><strong>Time Range:</strong> Events displayed cover the next 7 days from today.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;"><a href="https://www.torontopubliclibrary.ca/" target="_blank" rel="noopener noreferrer" style="color: #E91E63; text-decoration: none;">Toronto Public Library (TPL)</a></h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Library events including storytimes, crafts, STEM programs, and educational activities are sourced from the <strong><a href="https://open.toronto.ca/dataset/toronto-public-library-branch-general-information/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Toronto Public Library Open Data API</a></strong>. This official <a href="https://en.wikipedia.org/wiki/Application_programming_interface" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">API</a> provides real-time event information from all 100+ TPL branches across Toronto.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;">Museums & Cultural Institutions</h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Free admission events are compiled from the <strong><a href="https://www.rom.on.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Royal Ontario Museum (ROM)</a></strong>, <strong><a href="https://ago.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Art Gallery of Ontario (AGO)</a></strong>, <strong><a href="https://www.ontariosciencecentre.ca/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Ontario Science Centre</a></strong>, and <strong><a href="https://www.harbourfrontcentre.com/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Harbourfront Centre</a></strong>. These include Third Tuesday Night Free, First Wednesday Night Free, weekend free floor programs, and ongoing cultural activities.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;">Community Centres</h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Drop-in programs including playgroups, youth programs, family gym time, and arts & crafts sessions are compiled from <strong>18 major Toronto community centres</strong> including Scadding Court, High Park, Beaches, Leaside Memorial Gardens, St Lawrence, and others across the city.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;"><a href="https://www.toronto.ca/community-people/children-parenting/children-programs-activities/early-learning-child-care-centres/earlyon-child-family-centres/" target="_blank" rel="noopener noreferrer" style="color: #E91E63; text-decoration: none;">EarlyON Child and Family Centres</a></h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Free drop-in programs for children ages 0-6 and their caregivers are sourced from <strong><a href="https://www.toronto.ca/community-people/children-parenting/children-programs-activities/early-learning-child-care-centres/earlyon-child-family-centres/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">EarlyON Child and Family Centres</a></strong> across Toronto. These programs provide play, learning, and community connections for families with young children.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;"><a href="https://www.toronto.ca/explore-enjoy/recreation/" target="_blank" rel="noopener noreferrer" style="color: #E91E63; text-decoration: none;">Parks & Recreation</a></h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Drop-in recreational programs including swimming, skating, gym time, and sports activities are compiled from the <strong><a href="https://www.toronto.ca/explore-enjoy/recreation/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">City of Toronto Parks, Forestry & Recreation</a></strong> program database, covering hundreds of facilities across the city.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;">Community Events</h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Additional community events, festivals, workshops, and activities are sourced from various community organizations, cultural groups, and event platforms including ChatterBlock, Family Fun Canada, and local community partners.</p>

                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin: 24px 0 12px;">Location & Mapping</h3>
                <p style="margin-bottom: 24px; line-height: 1.8; color: #000;">Event locations and mapping utilize <strong><a href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Google Maps</a></strong>. Distance calculations use the <strong><a href="https://en.wikipedia.org/wiki/Haversine_formula" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: underline;">Haversine formula</a></strong> for straight-line distances, which closely match actual walking distances in Toronto's grid-based street system.</p>

                <p style="margin-top: 24px; line-height: 1.8; font-style: italic; color: #000;"><strong>Note:</strong> Toronto Kids Events is an independent resource and is not affiliated with or endorsed by any government agency, institution, or organization. All event information is provided for informational purposes only. Please verify details with event organizers before attending.</p>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contact-modal" onclick="if(event.target.id==='contact-modal') this.style.display='none'" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 999999; padding: 20px; overflow-y: scroll;">
        <div onclick="event.stopPropagation()">
                <h2 style="font-size: 2.5rem; font-weight: 900; color: #D81B60; margin-bottom: 16px; text-shadow: 2px 2px 4px rgba(216, 27, 96, 0.2);">Contact</h2>
                <h3 style="font-size: 1.5rem; font-weight: 600; color: #E91E63; margin-bottom: 8px;">Joshua Opolko</h3>
                <p style="margin-bottom: 32px; line-height: 1.8; color: #000;">VR/AI Researcher & Developer | Technology Innovation Leader</p>

                <div style="margin: 32px 0;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #FFF0F5 0%, #F9F0FB 100%); border-radius: 12px;">
                        <span style="font-size: 32px; width: 40px; text-align: center;">üíº</span>
                        <div>
                            <div style="font-weight: 700; margin-bottom: 4px; color: #000;">LinkedIn</div>
                            <a href="https://www.linkedin.com/in/joshua-opolko/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: none; font-weight: 600;">linkedin.com/in/joshua-opolko</a>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #F0F8FF 0%, #F3F5FF 100%); border-radius: 12px;">
                        <span style="font-size: 32px; width: 40px; text-align: center;">ùïè</span>
                        <div>
                            <div style="font-weight: 700; margin-bottom: 4px; color: #000;">X (Twitter)</div>
                            <a href="https://x.com/JoshuaOpolko" target="_blank" rel="noopener noreferrer" style="color: #87BBFF; text-decoration: none; font-weight: 600;">x.com/JoshuaOpolko</a>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #FFF0F5 0%, #F9F0FB 100%); border-radius: 12px;">
                        <span style="font-size: 32px; width: 40px; text-align: center;">üåê</span>
                        <div>
                            <div style="font-weight: 700; margin-bottom: 4px; color: #000;">Website</div>
                            <a href="https://joshuaopolko.com/" target="_blank" rel="noopener noreferrer" style="color: #D81B60; text-decoration: none; font-weight: 600;">joshuaopolko.com</a>
                        </div>
                    </div>
                </div>

                <p style="margin-top: 32px; line-height: 1.8; color: #000;">Have feedback or suggestions? Want to report an issue or contribute event data? Feel free to reach out via any of the channels above.</p>
        </div>
    </div>

    <!-- PWA Service Worker Registration -->
    <script>
        // Check if service workers are supported
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/kidsevents/sw.js')
                    .then(registration => {
                        console.log('PWA: Service Worker registered successfully:', registration.scope);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute

                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, show update prompt
                                    if (confirm('New version available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('PWA: Service Worker registration failed:', error);
                    });
            });

            // Handle install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                console.log('PWA: Install prompt available');

                // Optionally, show your own install button
                // You could create a banner or button to prompt installation
                showInstallPromotion();
            });

            function showInstallPromotion() {
                // Create an install banner (optional)
                const installBanner = document.createElement('div');
                installBanner.id = 'install-banner';
                installBanner.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #4CAF50;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    z-index: 10000;
                    animation: slideUp 0.3s ease;
                `;
                installBanner.innerHTML = `
                    <span>üì± Install this app for quick access!</span>
                    <button id="install-button" style="background: white; color: #4CAF50; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">Install</button>
                    <button id="dismiss-button" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 8px; cursor: pointer;">Later</button>
                `;
                document.body.appendChild(installBanner);

                document.getElementById('install-button').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`PWA: User response to install prompt: ${outcome}`);
                        deferredPrompt = null;
                        installBanner.remove();
                    }
                });

                document.getElementById('dismiss-button').addEventListener('click', () => {
                    installBanner.remove();
                });
            }

            // Log when app is installed
            window.addEventListener('appinstalled', () => {
                console.log('PWA: App installed successfully!');
                // Optional: Track installation in analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'pwa_installed', {
                        'event_category': 'PWA',
                        'event_label': 'App Installed'
                    });
                }
            });
        }
    </script>

</body>
</html>
